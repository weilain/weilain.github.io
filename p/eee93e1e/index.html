<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Nginx rewrite模块深入浅出详解 | 奇怪的运气</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="ewrite模块（ngx_http_rewrite_module）nginx通过ngx_http_rewrite_module模块支持url重写、支持if条件判断，但不支持else。另外该模块需要PCRE支持，应在编译nginx时指定PCRE支持。根据相关变量重定向和选择不同的配置，从一个location跳转到另一个location，不过这样的循环最多可以执行10次，超过后nginx将返回500错">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx rewrite模块深入浅出详解">
<meta property="og:url" content="https://www.webpages.show/p/eee93e1e/index.html">
<meta property="og:site_name" content="奇怪的运气">
<meta property="og:description" content="ewrite模块（ngx_http_rewrite_module）nginx通过ngx_http_rewrite_module模块支持url重写、支持if条件判断，但不支持else。另外该模块需要PCRE支持，应在编译nginx时指定PCRE支持。根据相关变量重定向和选择不同的配置，从一个location跳转到另一个location，不过这样的循环最多可以执行10次，超过后nginx将返回500错">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2020-07-22T16:00:00.000Z">
<meta property="article:modified_time" content="2020-07-26T10:46:00.135Z">
<meta property="article:author" content="Hermoso">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="rewrite">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="奇怪的运气" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.1"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">奇怪的运气</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://www.webpages.show"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Nginx-rewrite模块深入浅出详解" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/p/eee93e1e/" class="article-date">
  <time datetime="2020-07-22T16:00:00.000Z" itemprop="datePublished">2020-07-23</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Nginx/">Nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Nginx rewrite模块深入浅出详解
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h5 id="ewrite模块（ngx-http-rewrite-module）"><a href="#ewrite模块（ngx-http-rewrite-module）" class="headerlink" title="ewrite模块（ngx_http_rewrite_module）"></a>ewrite模块（ngx_http_rewrite_module）</h5><p>nginx通过ngx_http_rewrite_module模块支持url重写、支持if条件判断，但不支持else。另外该模块需要PCRE支持，应在编译nginx时指定PCRE支持。根据相关变量重定向和选择不同的配置，从一个location跳转到另一个location，不过这样的循环最多可以执行10次，超过后nginx将返回500错误。同时，重写模块包含set指令，来创建新的变量并设其值，这在有些情景下非常有用的，如记录条件标识、传递参数到其他location、记录做了什么等等。学习rewrite之前要对正则表达式要很熟悉，下面先给出一些常用的正则表达式元字符。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.     :匹配除换行符以外的任意字符</span><br><span class="line">?     :重复0次或1次</span><br><span class="line">+     :重复1次或更多次</span><br><span class="line">*     :重复0次或更多次</span><br><span class="line">\d    :匹配数字</span><br><span class="line">^     :匹配字符串的开始字符</span><br><span class="line">$     :匹配字符串的结束字符</span><br><span class="line">&#123;n&#125;   :重复n次</span><br><span class="line">&#123;n,&#125;  :重复n次或更多次</span><br><span class="line">[c]   :匹配单个字符c</span><br><span class="line">[a-z] :匹配a-z小写字母的任意一个</span><br></pre></td></tr></table></figure>

<p>在rewrite中，如果使用小括号()，那么在小括号之间匹配的内容，可以在后面通过$1来引用，$2表示的是前面第二个()里的内容，后面会说到。</p>
<h6 id="Rewrite模块指令"><a href="#Rewrite模块指令" class="headerlink" title="Rewrite模块指令"></a>Rewrite模块指令</h6><p>1）break</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: break;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure>

<p>此指令的意思是停止执行当前虚拟主机的后续rewrite指令集。使用示例如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if ($slow) &#123;</span><br><span class="line">     limit_rate 10k;</span><br><span class="line">     break;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）if  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: if (condition) &#123; ... &#125;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location</span><br></pre></td></tr></table></figure>

<p>对给定的条件（condition）进行判断，如果条件为真，大括号内的rewrite指令将被执行。</p>
<p>条件(conditon)可以是如下任何操作：</p>
<ul>
<li><ol>
<li>当表达式只是一个变量时，如果值为空或任何以0开头的字符串都会当做false；</li>
</ol>
</li>
<li><ol start="2">
<li>使用“=”和“!=”比较一个变量和字符串；</li>
</ol>
</li>
<li><ol start="3">
<li>使用“<del>”做正则表达式匹配，“</del>*”做不区分大小写的正则匹配，“!~”做区分大小写的正则不匹配；</li>
</ol>
</li>
<li><ol start="4">
<li>使用“-f”和“!-f” 检查一个文件是否存在；</li>
</ol>
</li>
<li><ol start="5">
<li>使用“-d”和“!-d”检查一个目录是否存在；</li>
</ol>
</li>
<li><ol start="6">
<li>使用“-e”和“!-e”检查一个文件、目录、符号链接是否存在；</li>
</ol>
</li>
<li><ol start="7">
<li>使用“-x”和“ !-x”检查一个文件是否可执行；<br>如下示例：</li>
</ol>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;如果UA包含&quot;MSIE&quot;，rewrite请求到&#x2F;msid&#x2F;目录下</span><br><span class="line">if ($http_user_agent ~ MSIE) &#123;</span><br><span class="line">    rewrite ^(.*)$ &#x2F;msie&#x2F;$1 break;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;如果cookie匹配正则，设置变量$id等于正则引用部分</span><br><span class="line">if ($http_cookie ~* &quot;id&#x3D;([^;]+)(?:;|$)&quot;) &#123;</span><br><span class="line">    set $id $1;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;给某个访问IP返回403</span><br><span class="line">if ( $remote_addr &#x3D; &quot;202\.38\.78\.85&quot; )&#123;</span><br><span class="line">    return 403;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;如果提交方法为POST，则返回状态405（Method not allowed）。return不能返回301,302</span><br><span class="line">if ($request_method &#x3D; POST) &#123;</span><br><span class="line">    return 405;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;如果$slow可以通过set指令设置，则进行限速处理</span><br><span class="line">if ($slow) &#123;</span><br><span class="line">    limit_rate 10k;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;如果请求的文件名不存在，则反向代理到localhost 。这里的break也是停止rewrite检查</span><br><span class="line">if (!-f $request_filename)&#123;</span><br><span class="line">    break;</span><br><span class="line">    proxy_pass http:&#x2F;&#x2F;127.0.0.1;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;如果query string中包含&quot;post&#x3D;140&quot;，则永久重定向到example.com</span><br><span class="line">if ($args ~ post&#x3D;140)&#123;</span><br><span class="line">    rewrite ^ http:&#x2F;&#x2F;example.com&#x2F; permanent;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line">&#x2F;&#x2F;防盗链</span><br><span class="line">location ~* \.(gif|jpg|png|swf|flv)$ &#123;</span><br><span class="line">    valid_referers none blocked www.baidu.com www.ywnds.com;</span><br><span class="line">    if ($invalid_referer) &#123;</span><br><span class="line">        return 404;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）return</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Syntax: return code [text];</span><br><span class="line">        return code URL;</span><br><span class="line">        return URL;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure>

<p>停止处理并为客户端返回状态码，非标准的444状态码将关闭连接，不发送任何响应头。可以使用的状态码有：204，400，402-406，408，410, 411, 413, 416与500-504。如果状态码附带文字段落，该文本将被放置在响应主体。相反，如果状态码后面是一个URL，该URL将成为location头部值。没有状态码的URL将被视为一个302状态码。</p>
<p>4）rewrite</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: rewrite regex replacement [flag];</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure>

<p>rewrite指令的功能就是，使用nginx提供的全局变量或自己设置的变量，然后结合正则表达式和标志位实现url重写以及重定向。rewrite指令只能放在server、location或if中，并且只能对域名后边的除去传递的参数外的字符串起作用，例如 <a href="http://ywnds.com/a/we/index.php?id=1&amp;u=str，只对/a/we/index.php重写，语法如上面所示。" target="_blank" rel="noopener">http://ywnds.com/a/we/index.php?id=1&amp;u=str，只对/a/we/index.php重写，语法如上面所示。</a></p>
<p>如果想对域名或参数字符串起作用，可以使用全局变量匹配，也可以使用proxy_pass反向代理。</p>
<p>或许看rewrite和location功能有点像，都能实现跳转，主要区别在于rewrite是在同一域名内更改获取资源的路径，而location是对一类路径做控制访问或反向代理，可以proxy_pass到其他机器。很多情况下rewrite也会写在location里，它们的执行顺序是：</p>
<p>1）处理在server级别中定义的模块指令；</p>
<p>2）为请求查找location；</p>
<p>3）处理在选中的location中定义的模块指令，如果指令改变了URI，按新的URI查找location。这个循环至多重复10次，之后nginx返回错误500 (Internal Server Error)；</p>
<p>如果一个URI匹配了rewrite指令指定的正则表达式（regex），则URI就按照replacement进行重写，而rewrite按配置文件中出现的顺序执行。其中flag标志可以停止继续处理。如果replacement以”http://”或”https://”开始，将不再继续处理，那么这个重定向将直接返回给客户端。</p>
<p>flag可以是如下参数：</p>
<p>last，完成该rewrite规则的执行后，停止处理后续rewrite指令集；然后查找匹配改变后URI的新location；</p>
<p>break，完成该rewrite规则的执行后，停止处理后续rewrite指令集，并不再重新查找；但是当前location内剩余非rewrite语句和location外的的非rewrite语句可以执行；</p>
<p>redirect，返回302临时重定向，地址栏会显示跳转后的地址；</p>
<p>permanent，返回301永久重定向，地址栏会显示跳转后的地址；即表示如果客户端不清理浏览器缓存，那么返回的结果将永久保存在客户端浏览器中了。</p>
<p>因为301和302不能简单的只返回状态码，还必须有重定向的URL，这就是return指令无法返回301,302的原因了。这里last和break区别有点难以理解：</p>
<p>1）last一般写在server和if中，而break一般使用在location中；</p>
<p>2）last不终止重写后的url匹配，即新的url会再从server走一遍匹配流程，而break终止重写后的匹配；</p>
<p>3）break和last都能组织继续执行后面的rewrite指令。</p>
<p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">     ...</span><br><span class="line">     rewrite ^(&#x2F;download&#x2F;.*)&#x2F;media&#x2F;(.*)..*$ $1&#x2F;mp3&#x2F;$2.mp3 last;</span><br><span class="line">     rewrite ^(&#x2F;download&#x2F;.*)&#x2F;audio&#x2F;(.*)..*$ $1&#x2F;mp3&#x2F;$2.ra last;</span><br><span class="line">     return 403;</span><br><span class="line">     ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果这些rewrite放到“/download/”路径，那么location如下所示，这时应使用break而不是last，使用last将循环10次匹配，然后返回500错误:   </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">location &#x2F;download&#x2F; &#123;</span><br><span class="line">     rewrite ^(&#x2F;download&#x2F;.*)&#x2F;media&#x2F;(.*)..*$ $1&#x2F;mp3&#x2F;$2.mp3 break;</span><br><span class="line">     rewrite ^(&#x2F;download&#x2F;.*)&#x2F;audio&#x2F;(.*)..*$ $1&#x2F;mp3&#x2F;$2.ra break;</span><br><span class="line">     return 403;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对于重写后的URL（replacement）包含原请求的请求参数，原URL的?后的内容。如果不想带原请求的参数，可以在replacement后加一个问号。如下，我们加了一个自定义的参数user=$1,然后在结尾处放了一个问号?，把原请求的参数去掉。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^&#x2F;users&#x2F;(.*)$ &#x2F;show?user&#x3D;$1? last;</span><br></pre></td></tr></table></figure>
<p>注: 对花括号“}”或“;”来说，使用时需要用双引号或单引号包围。因为他们既能用在重定向的正则表达式里，也是用在配置文件里分割代码块, 为了避免冲突, 正则表达式里带花括号的话，应该用双引号（或者单引号）包围。比如，要将类似以下的URI：”/photos/123456″重定向到”/path/to/photos/12/1234/123456.png”可以用以下方法 (注意双引号):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite &quot;&#x2F;photos&#x2F;([0-9] &#123;2&#125;)([0-9] &#123;2&#125;)([0-9] &#123;2&#125;)&quot; &#x2F;path&#x2F;to&#x2F;photos&quot;</span><br></pre></td></tr></table></figure>

<p>5）set</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: set $variable value;</span><br><span class="line">Default:—</span><br><span class="line">Context:server, location, if</span><br></pre></td></tr></table></figure>

<p>定义一个变量并赋值，值可以是文本，变量或者文本变量混合体。</p>
<p>6）rewrite_log</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: rewrite_log on | off;</span><br><span class="line">Default:rewrite_log off;</span><br><span class="line">Context:http, server, location, if</span><br></pre></td></tr></table></figure>

<p>开启或关闭以notice级别打印rewrite处理日志到error log文件。nginx打开rewrite log的例子如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rewrite_log on;                        &#x2F;&#x2F;打开rewrite log</span><br><span class="line">error_log logs&#x2F;xxx.error.log notice;   &#x2F;&#x2F;把error log的级别调整为notice</span><br></pre></td></tr></table></figure>

<p>7）uninitialized_variable_warn  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Syntax: uninitialized_variable_warn on | off;</span><br><span class="line">Default:uninitialized_variable_warn on;</span><br><span class="line">Context:http, server, location, if</span><br></pre></td></tr></table></figure>

<p>控制是否输出为初始化的变量到日志。</p>
<p>重写规则组成部分</p>
<p>第一部分：任何重写规则的第一部分都是一个正则表达式</p>
<p>正则表达式可以使用括号来捕获，后续可以根据位置来将其引用，位置变量值取决于捕获正则表达式中的顺序，$1引用第一个括号中的值，$2引用第二个括号中的值，以此类推。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">^&#x2F;images&#x2F;([a-z]&#123;2&#125;)&#x2F;([a-z0-9]&#123;5&#125;)&#x2F;(.*)\.(png|jpg|gif)$</span><br></pre></td></tr></table></figure>

<p>$1是两个小写字母组成的字符串，$2是由小写字母和0到9的数字组成的5个字符的字符串，$3将是个文件名，$4是png、jpg、gif中的其中一个。</p>
<p>第二部分：重写规则的第二部分是URI</p>
<p>当重写规则第一部分被匹配到了之后，则请求被改写，那么该URI可能包含正则表达式中的捕获的位置参数或这个级别下的nginx任何配置变量。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;data?file&#x3D;$3.$4</span><br></pre></td></tr></table></figure>

<p>如果这个URI不匹配nginx配置的任何location，那么将给客户端返回301(永久重定向)或302(临时重定向)的状态码来表示重定向类型。该状态码可以通过第三个参数来明确指定。</p>
<p>第三部分：重写规则的第三部分就是标记（flag）</p>
<p>第三部分也就是尾部的标记（flag）， last标记将导致重写后的URI搜索匹配nginx的其他location，最多可循环10次。如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite &#39;^&#x2F;images&#x2F;([a-z]&#123;2&#125;)&#x2F;([a-z0-9]&#123;5&#125;)&#x2F;(.*)\.(png|jpg|gif)$&#39; &#x2F;data?file&#x3D;$3.$4 last;</span><br></pre></td></tr></table></figure>

<p>全局变量</p>
<p>下面是可以用作if判断的全局变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">$args               #这个变量等于请求行中的参数，同$query_string;</span><br><span class="line">$content_length     #请求头中的Content-length字段;</span><br><span class="line">$content_type       #请求头中的Content-Type字段;</span><br><span class="line">$document_root      #当前请求在root指令中指定的值，如:root &#x2F;var&#x2F;www&#x2F;html;</span><br><span class="line">$host               #请求主机头字段，否则为服务器名称;</span><br><span class="line">$http_user_agent    #客户端agent信息;</span><br><span class="line">$http_cookie        #客户端cookie信息;</span><br><span class="line">$limit_rate         #这个变量可以限制连接速率;</span><br><span class="line">$request_method     #客户端请求的动作，通常为GET或POST;</span><br><span class="line">$remote_addr        #客户端的IP地址;</span><br><span class="line">$remote_port        #客户端的端口;</span><br><span class="line">$remote_user        #已经经过Auth Basic Module验证的用户名;</span><br><span class="line">$request_filename   #当前请求的文件路径，由root或alias指令与URI请求生成;</span><br><span class="line">$scheme             #HTTP方法（如http，https）;</span><br><span class="line">$server_protocol    #请求使用的协议，通常是HTTP&#x2F;1.0或HTTP&#x2F;1.1;</span><br><span class="line">$server_addr        #服务器地址，在完成一次系统调用后可以确定这个值;</span><br><span class="line">$server_name        #服务器名称;</span><br><span class="line">$server_port        #请求到达服务器的端口号;</span><br><span class="line">$request_uri        #包含请求参数的原始URI，不包含主机名，如：”&#x2F;foo&#x2F;bar.php?arg&#x3D;baz”;</span><br><span class="line">$uri                #不带请求参数的当前URI，$uri不包含主机名，如”&#x2F;foo&#x2F;bar.html”;</span><br><span class="line">$document_uri       #与$uri相同,例：http:&#x2F;&#x2F;localhost:88&#x2F;test1&#x2F;test2&#x2F;test.php;</span><br></pre></td></tr></table></figure>

<p>例如：<a href="http://localhost:88/test1/test2/test.php这个URL，其中：" target="_blank" rel="noopener">http://localhost:88/test1/test2/test.php这个URL，其中：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$host：localhost</span><br><span class="line">$server_port：88</span><br><span class="line">$request_uri：http:&#x2F;&#x2F;localhost:88&#x2F;test1&#x2F;test2&#x2F;test.php</span><br><span class="line">$document_uri：&#x2F;test1&#x2F;test2&#x2F;test.php</span><br><span class="line">$document_root：&#x2F;var&#x2F;www&#x2F;html</span><br><span class="line">$request_filename：&#x2F;var&#x2F;www&#x2F;html&#x2F;test1&#x2F;test2&#x2F;test.php</span><br></pre></td></tr></table></figure>

<p>Rewrite模块使用实例</p>
<p>1）使用rewrite指令把访问80端口的请求重定向到443</p>
<p>对于HTTPS网站，一般最少需要定义两个虚拟主机，一个是使用80的虚拟主机，另一个就是使用443端口的虚拟主机了。比如在浏览器输入<a href="http://www.ywnds.com（http://www.ywnds.com）会自动跳转到https://www.ywnds.com。" target="_blank" rel="noopener">www.ywnds.com（http://www.ywnds.com）会自动跳转到https://www.ywnds.com。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^(.*)$ https:&#x2F;&#x2F;www.ywnds.com$uri redirect;</span><br></pre></td></tr></table></figure>
<p>这种跳转就是302临时重定向跳转，如果把flag变成permanent就成了301永久重定向跳转了。</p>
<p>2）作为重写规则的一部分，传递新的查询字符串参数是使用重写规则的目标之一</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rewrite ^&#x2F;images&#x2F;(.*)_(\d+)x(\d+)\.(png|jpg|gif)$ &#x2F;resizer&#x2F;$1.$4?width&#x3D;$2&amp;height&#x3D;$3? last;</span><br></pre></td></tr></table></figure>

<p>3）使用rewrite模块禁止用户代理</p>
<p>Nginx可以通过各种方式来限制访问，例如NGINX基本Http认证、allow/deny等等，这些都是前文提过的，下面来看看nginx如何通过用户代理来禁止访问。</p>
<p>user agent是什么?</p>
<p>简单来说告诉服务器你当前使用的是什么浏览器、工具等来访问我的。例如火狐、chrome、wget、curl等浏览器或工具。使用$http_user_agent变量就可以获取到用户代理，一般在定义日志格式时都会使用这个变量，把用户代理记录到日志中去。</p>
<p>如何禁止特定UA？</p>
<p>我们不希望被使用wget或者curl来下载我的文件，怎么做呢？这里就可以使用rewrite模块了，编辑nginx配置文件，以下内容放在http配置段，那么整个nginx都生效。如果放到server里，那么一个域名生效，你放哪，哪就有效！</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~* (curl) ) &#123;</span><br><span class="line">    return 404;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>禁止多个UA</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if ($http_user_agent ~* (wget|curl) ) &#123;</span><br><span class="line">    return 404;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>nginx重写规则说起来挺简单的，做起来就难，重点在于正则表达式，同时，还需要考虑到nginx执行顺序。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://www.webpages.show/p/eee93e1e/" data-id="ckd4a8akd0008q8z8gk5x4c0f" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rewrite/" rel="tag">rewrite</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/p/8eb47741/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          利用docker实现mysql主从同步读写分离，附赠docker搭建mycat读写分离
        
      </div>
    </a>
  
  
    <a href="/p/492994d9/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">nginx expires配置详解</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Gitlab/">Gitlab</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Nginx/">Nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/OpenSSH/">OpenSSH</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/hexo/">hexo</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Gitlab/" rel="tag">Gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/OpenSSh/" rel="tag">OpenSSh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/douban/" rel="tag">douban</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/expires/" rel="tag">expires</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/hexo/" rel="tag">hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/" rel="tag">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/location/" rel="tag">location</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mycat/" rel="tag">mycat</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/" rel="tag">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/" rel="tag">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy-pass/" rel="tag">proxy_pass</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rewrite/" rel="tag">rewrite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%94%E5%9B%9E%E7%A0%81/" rel="tag">返回码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%87%8D%E5%AE%9A%E5%90%91/" rel="tag">重定向</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Gitlab/" style="font-size: 15px;">Gitlab</a> <a href="/tags/OpenSSh/" style="font-size: 10px;">OpenSSh</a> <a href="/tags/docker/" style="font-size: 10px;">docker</a> <a href="/tags/douban/" style="font-size: 10px;">douban</a> <a href="/tags/expires/" style="font-size: 10px;">expires</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/location/" style="font-size: 10px;">location</a> <a href="/tags/mycat/" style="font-size: 10px;">mycat</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nginx/" style="font-size: 20px;">nginx</a> <a href="/tags/proxy-pass/" style="font-size: 10px;">proxy_pass</a> <a href="/tags/rewrite/" style="font-size: 15px;">rewrite</a> <a href="/tags/%E8%BF%94%E5%9B%9E%E7%A0%81/" style="font-size: 10px;">返回码</a> <a href="/tags/%E9%87%8D%E5%AE%9A%E5%90%91/" style="font-size: 10px;">重定向</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/07/">七月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">十二月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/p/2651b0bd/">hexo-douban 插件使用与问题</a>
          </li>
        
          <li>
            <a href="/p/12223247/">记一次Centos7.5升级OpenSSH8.0p1</a>
          </li>
        
          <li>
            <a href="/p/5e94d2a7/">gitlab配置域名并https访问</a>
          </li>
        
          <li>
            <a href="/p/328665dd/">nginx 返回码 426 upgrade required 处理</a>
          </li>
        
          <li>
            <a href="/p/bb2a8a2e/">常见的重定向方式</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Hermoso<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>